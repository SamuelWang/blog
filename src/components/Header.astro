---
interface NavLink {
  href: string;
  label: string;
  isActive: boolean;
}

const siteName = 'Samuel Wang';
const currentLocale = Astro.currentLocale || 'en';
const currentUrl = Astro.url;
const currentPath = currentUrl.pathname.replace(`/${currentLocale}`, '');
const rootPath = `/${currentLocale}/`;
const isArticlesPage = currentUrl.pathname.startsWith(`/${currentLocale}/articles`);
const isAboutPage = currentUrl.pathname.startsWith(`/${currentLocale}/about`);
const navLinks: NavLink[] = [
  { href: `${rootPath}articles`, label: currentLocale === 'en' ? 'Articles' : '文章列表', isActive: isArticlesPage },
  { href: `${rootPath}about`, label: currentLocale === 'en' ? 'About' : '關於我', isActive: isAboutPage },
];
---

<nav class='bg-neutral-primary fixed w-screen z-20 top-0 start-0 border-b border-default shadow'>
  <div class='relative flex flex-wrap items-center justify-between mx-auto p-4 lg:px-8'>
    <a href={rootPath} class='flex items-center space-x-3 rtl:space-x-reverse'>
      <span class='self-center text-xl text-heading font-semibold whitespace-nowrap'>{siteName}</span>
    </a>

    <!-- Hamburger menu -->
    <button
      data-collapse-toggle='navbar-hamburger'
      type='button'
      class='inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-body rounded-base md:hidden hover:bg-neutral-secondary-soft hover:text-heading focus:outline-none focus:ring-2 focus:ring-neutral-tertiary'
      aria-controls='navbar-hamburger'
      aria-expanded='false'
    >
      <span class='sr-only'>Open main menu</span>
      <svg
        class='w-6 h-6'
        aria-hidden='true'
        xmlns='http://www.w3.org/2000/svg'
        width='24'
        height='24'
        fill='none'
        viewBox='0 0 24 24'
        ><path stroke='currentColor' stroke-linecap='round' stroke-width='2' d='M5 7h14M5 12h14M5 17h14'></path></svg
      >
    </button>
    <!-- Menu -->
    <div class='items-center justify-between hidden w-full md:flex md:gap-4 md:w-auto md:order-1' id='navbar-hamburger'>
      <ul
        class='font-medium flex flex-col p-4 md:p-0 mt-4 border border-default rounded-base bg-neutral-secondary-soft md:flex-row md:space-x-8 rtl:space-x-reverse md:mt-0 md:border-0 md:bg-neutral-primary'
      >
        {
          navLinks.map((link) => (
            <li>
              <a
                href={link.href}
                class='block py-2 px-3'
                class:list={
                  link.isActive
                    ? ['text-white', 'bg-brand', 'rounded', 'md:bg-transparent', 'md:text-fg-brand', 'md:p-0']
                    : [
                        'text-heading',
                        'rounded',
                        'hover:bg-neutral-tertiary',
                        'md:hover:bg-transparent',
                        'md:border-0',
                        'md:hover:text-fg-brand',
                        'md:p-0',
                        'md:dark:hover:bg-transparent',
                      ]
                }
                aria-current={link.isActive ? 'page' : undefined}
              >
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>

      <div class='flex items-center mt-4 md:order-2 md:mt-0'>
        <!-- Language toggle -->
        <div class='relative'>
          <button
            id='language-toggle'
            type='button'
            class='text-gray-500 cursor-pointer dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 flex items-center gap-1'
          >
            <svg class='w-5 h-5' fill='currentColor' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'>
              <path
                fill-rule='evenodd'
                d='M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z'
                clip-rule='evenodd'></path>
            </svg>
            <span class='text-sm font-medium'>{currentLocale === 'en' ? 'EN' : '繁體中文'}</span>
            <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'>
              <path
                fill-rule='evenodd'
                d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z'
                clip-rule='evenodd'></path>
            </svg>
          </button>
          <div
            id='language-dropdown'
            class='hidden absolute left-0 md:left-auto md:right-0 mt-2 w-40 bg-white dark:bg-gray-700 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50'
          >
            <ul class='rounded-lg'>
              <li>
                <a
                  href={currentLocale === 'en' ? currentUrl.pathname : `/en${currentPath}`}
                  class='block px-4 py-2 text-sm rounded-t-lg text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600'
                  class:list={currentLocale === 'en' ? ['bg-gray-100', 'dark:bg-gray-600', 'font-semibold'] : []}
                >
                  English
                </a>
              </li>
              <li>
                <a
                  href={currentLocale === 'zh-tw' ? currentUrl.pathname : `/zh-tw${currentPath}`}
                  class='block px-4 py-2 text-sm text-gray-700 rounded-b-lg dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600'
                  class:list={currentLocale === 'zh-tw' ? ['bg-gray-100', 'dark:bg-gray-600', 'font-semibold'] : []}
                >
                  繁體中文
                </a>
              </li>
            </ul>
          </div>
        </div>
        <!-- Theme toggle -->
        <button
          id='theme-toggle'
          type='button'
          class='text-gray-500 cursor-pointer dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5'
        >
          <svg
            id='theme-toggle-dark-icon'
            class='hidden w-5 h-5'
            fill='currentColor'
            viewBox='0 0 20 20'
            xmlns='http://www.w3.org/2000/svg'
            ><path d='M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z'></path></svg
          >
          <svg
            id='theme-toggle-light-icon'
            class='hidden w-5 h-5'
            fill='currentColor'
            viewBox='0 0 20 20'
            xmlns='http://www.w3.org/2000/svg'
            ><path
              d='M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z'
              fill-rule='evenodd'
              clip-rule='evenodd'></path></svg
          >
        </button>
      </div>
    </div>
  </div>
</nav>

<script>
  // --- START DARK MODE INITIALIZATION ---
  const isDarkMode =
    localStorage.getItem('color-theme') === 'dark' ||
    (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);

  // On page load or when changing themes, best to add inline in `head` to avoid FOUC
  if (isDarkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }

  var themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
  var themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

  // Change the icons inside the button based on previous settings
  if (isDarkMode) {
    themeToggleLightIcon?.classList.remove('hidden');
  } else {
    themeToggleDarkIcon?.classList.remove('hidden');
  }

  var themeToggleBtn = document.getElementById('theme-toggle');

  themeToggleBtn?.addEventListener('click', function () {
    // toggle icons inside button
    themeToggleDarkIcon?.classList.toggle('hidden');
    themeToggleLightIcon?.classList.toggle('hidden');

    // if set via local storage previously
    if (localStorage.getItem('color-theme')) {
      if (localStorage.getItem('color-theme') === 'light') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('color-theme', 'dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('color-theme', 'light');
      }

      // if NOT set via local storage previously
    } else {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('color-theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('color-theme', 'dark');
      }
    }
  });
  // --- END DARK MODE INITIALIZATION ---

  // --- START LANGUAGE DROPDOWN ---
  const languageToggleBtn = document.getElementById('language-toggle');
  const languageDropdown = document.getElementById('language-dropdown');

  languageToggleBtn?.addEventListener('click', function (event) {
    event.stopPropagation();
    languageDropdown?.classList.toggle('hidden');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function (event) {
    const target = event.target as HTMLElement;
    if (!languageToggleBtn?.contains(target) && !languageDropdown?.contains(target)) {
      languageDropdown?.classList.add('hidden');
    }
  });
  // --- END LANGUAGE DROPDOWN ---
</script>
